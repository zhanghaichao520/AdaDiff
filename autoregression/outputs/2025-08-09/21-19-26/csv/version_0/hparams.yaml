paths:
  root_dir: .
  data_dir: ../datasets/Baby
  log_dir: ./logs
  output_dir: /data/jwna230/peiyu/GenRec/MM-RQVAE/autoregression/outputs/2025-08-09/21-19-26
  work_dir: /data/jwna230/peiyu/GenRec/MM-RQVAE/autoregression
  profile_dir: outputs/2025-08-09/21-19-26/profile_output
  metadata_dir: /data/jwna230/peiyu/GenRec/MM-RQVAE/autoregression/outputs/2025-08-09/21-19-26/metadata
model:
  huggingface_model:
    _target_: transformers.T5EncoderModel
    config:
      _target_: transformers.T5Config
      vocab_size: 256
      d_model: 128
      num_heads: 6
      dropout_rate: 0.15
      d_ff: 1024
      d_kv: 64
      num_layers: 4
  _target_: src.models.modules.semantic_id.tiger_generation_model.SemanticIDEncoderDecoder
  feature_to_model_input_map:
    sequence_data: input_ids
    user_id: user_id
  postprocessor: null
  aggregator: null
  loss_function:
    _target_: torch.nn.CrossEntropyLoss
  optimizer:
    _target_: torch.optim.Adam
    _partial_: true
    lr: 0.001
    weight_decay: 0.0001
  scheduler: null
  evaluator:
    _target_: src.components.eval_metrics.SIDRetrievalEvaluator
    top_k_list:
    - 5
    - 10
    metrics:
      ndcg:
        _target_: src.components.eval_metrics.NDCG
        _partial_: true
      recall:
        _target_: src.components.eval_metrics.Recall
        _partial_: true
  weight_tying: true
  compile: false
  decoder:
    _target_: transformers.models.t5.modeling_t5.T5Stack
    config:
      _target_: transformers.models.t5.configuration_t5.T5Config
      vocab_size: 256
      d_model: 128
      num_heads: 6
      dropout_rate: 0.15
      d_ff: 1024
      d_kv: 64
      num_layers: 4
      is_decoder: true
      is_encoder_decoder: false
    embed_tokens:
      _target_: torch.nn.Embedding
      num_embeddings: 256
      embedding_dim: 128
  num_hierarchies: 4
  num_user_bins: null
  codebooks:
    _target_: torch.load
    _args_:
    - _target_: src.utils.file_utils.open_local_or_remote
      file_path: ../datasets/Baby/codebook.pt
      mode: rb
  mlp_layers: 2
model/params/total: 14963072
model/params/trainable: 14963072
model/params/non_trainable: 0
data_loading:
  features_config:
    features:
    - name: sequence_data
      num_placeholder_tokens: 0
      semantic_ids: ???
      is_item_ids: true
      type:
        _target_: torch.__dict__.get
        _args_:
        - int32
    - name: embedding
      type:
        _target_: torch.__dict__.get
        _args_:
        - float32
    - name: text
      type:
        _target_: torch.__dict__.get
        _args_:
        - bytes
    - name: user_id
      is_item_ids: true
      type:
        _target_: torch.__dict__.get
        _args_:
        - int32
  dataset_config:
    dataset:
      _target_: src.data.loading.components.interfaces.SemanticIDDatasetConfig
      user_id_field: user_id
      min_sequence_length: 5
      iterate_per_row: true
      keep_user_id: true
      features_to_consider:
      - sequence_data
      - user_id
      num_placeholder_tokens_map:
        sequence_data: 0
      semantic_id_map: {}
      data_iterator:
        _target_: src.data.loading.components.iterators.InterFileIterator
      preprocessing_functions:
      - _target_: src.data.loading.components.pre_processing.filter_features_to_consider
        _partial_: true
      - _target_: src.data.loading.components.pre_processing.convert_fields_to_tensors
        _partial_: true
      - _target_: src.data.loading.components.pre_processing.map_sparse_id_to_semantic_id
        _partial_: true
        features_to_apply:
        - sequence_data
        num_hierarchies: 4
      shuffle_buffer_size: 10000
  train_dataloader_config:
    dataloader:
      _target_: src.data.loading.components.interfaces.SequenceDataloaderConfig
      dataset_class:
        _target_: src.data.loading.components.dataloading.UnboundedSequenceIterable
        _partial_: true
      data_folder: ../datasets/Baby/training
      should_shuffle_rows: true
      labels:
        sequence_data:
          transform:
            _target_: src.data.loading.components.label_function.NextKTokenMasking
            next_k: 4
      batch_size_per_device: 512
      num_workers: 8
      timeout: 60
      assign_files_by_size: false
      oov_token: null
      masking_token: -1
      sequence_length: 120
      padding_token: -1
      drop_last: true
      persistent_workers: true
      collate_fn:
        _target_: src.data.loading.components.collate_functions.collate_with_sid_causal_duplicate
        _partial_: true
        sequence_length: 120
        padding_token: -1
        sequence_field_name: sequence_data
        sid_hierarchy: 4
        max_batch_size: 512
      dataset_config:
        _target_: src.data.loading.components.interfaces.SemanticIDDatasetConfig
        user_id_field: user_id
        min_sequence_length: 5
        iterate_per_row: true
        keep_user_id: true
        features_to_consider:
        - sequence_data
        - user_id
        num_placeholder_tokens_map:
          sequence_data: 0
        semantic_id_map:
          sequence_data:
            _target_: torch.load
            _args_:
            - _target_: src.utils.file_utils.open_local_or_remote
              file_path: ../datasets/Baby/codebook.pt
              mode: rb
        data_iterator:
          _target_: src.data.loading.components.iterators.InterFileIterator
          data_folder: ../datasets/Baby/training
          file_pattern: '*.train.inter'
          min_sequence_length: 5
        preprocessing_functions:
        - _target_: src.data.loading.components.pre_processing.filter_features_to_consider
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.convert_fields_to_tensors
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.map_sparse_id_to_semantic_id
          _partial_: true
          features_to_apply:
          - sequence_data
          num_hierarchies: 4
      assign_all_files_per_worker: true
  val_dataloader_config:
    dataloader:
      _target_: src.data.loading.components.interfaces.SequenceDataloaderConfig
      dataset_class:
        _target_: src.data.loading.components.dataloading.UnboundedSequenceIterable
        _partial_: true
      data_folder: ../datasets/Baby/evaluation
      should_shuffle_rows: false
      labels:
        sequence_data:
          transform:
            _target_: src.data.loading.components.label_function.NextKTokenMasking
            next_k: 4
      batch_size_per_device: 8
      num_workers: 8
      timeout: 60
      assign_files_by_size: true
      oov_token: null
      masking_token: -1
      sequence_length: 120
      padding_token: -1
      drop_last: false
      persistent_workers: false
      collate_fn:
        _target_: src.data.loading.components.collate_functions.collate_fn_train
        _partial_: true
        sequence_length: 120
        padding_token: -1
      dataset_config:
        _target_: src.data.loading.components.interfaces.SemanticIDDatasetConfig
        user_id_field: user_id
        min_sequence_length: 5
        iterate_per_row: true
        keep_user_id: true
        features_to_consider:
        - sequence_data
        - user_id
        num_placeholder_tokens_map:
          sequence_data: 0
        semantic_id_map:
          sequence_data:
            _target_: torch.load
            _args_:
            - _target_: src.utils.file_utils.open_local_or_remote
              file_path: ../datasets/Baby/codebook.pt
              mode: rb
        data_iterator:
          _target_: src.data.loading.components.iterators.InterFileIterator
          data_folder: ../datasets/Baby/evaluation
          file_pattern: '*.valid.inter'
          min_sequence_length: 5
        preprocessing_functions:
        - _target_: src.data.loading.components.pre_processing.filter_features_to_consider
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.convert_fields_to_tensors
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.map_sparse_id_to_semantic_id
          _partial_: true
          features_to_apply:
          - sequence_data
          num_hierarchies: 4
      pin_memory: false
  test_dataloader_config:
    dataloader:
      _target_: src.data.loading.components.interfaces.SequenceDataloaderConfig
      dataset_class:
        _target_: src.data.loading.components.dataloading.UnboundedSequenceIterable
        _partial_: true
      data_folder: ../datasets/Baby/testing
      should_shuffle_rows: false
      labels:
        sequence_data:
          transform:
            _target_: src.data.loading.components.label_function.NextKTokenMasking
            next_k: 4
      batch_size_per_device: 8
      num_workers: 8
      timeout: 60
      assign_files_by_size: true
      oov_token: null
      masking_token: -1
      sequence_length: 120
      padding_token: -1
      drop_last: false
      persistent_workers: false
      collate_fn:
        _target_: src.data.loading.components.collate_functions.collate_fn_train
        _partial_: true
        sequence_length: 120
        padding_token: -1
      dataset_config:
        _target_: src.data.loading.components.interfaces.SemanticIDDatasetConfig
        user_id_field: user_id
        min_sequence_length: 5
        iterate_per_row: true
        keep_user_id: true
        features_to_consider:
        - sequence_data
        - user_id
        num_placeholder_tokens_map:
          sequence_data: 0
        semantic_id_map:
          sequence_data:
            _target_: torch.load
            _args_:
            - _target_: src.utils.file_utils.open_local_or_remote
              file_path: ../datasets/Baby/codebook.pt
              mode: rb
        data_iterator:
          _target_: src.data.loading.components.iterators.InterFileIterator
          data_folder: ../datasets/Baby/testing
          file_pattern: '*.test.inter'
          min_sequence_length: 5
        preprocessing_functions:
        - _target_: src.data.loading.components.pre_processing.filter_features_to_consider
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.convert_fields_to_tensors
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.map_sparse_id_to_semantic_id
          _partial_: true
          features_to_apply:
          - sequence_data
          num_hierarchies: 4
      pin_memory: false
  datamodule:
    _target_: src.data.loading.datamodules.sequence_datamodule.SequenceDataModule
    train_dataloader_config:
      _target_: src.data.loading.components.interfaces.SequenceDataloaderConfig
      dataset_class:
        _target_: src.data.loading.components.dataloading.UnboundedSequenceIterable
        _partial_: true
      data_folder: ../datasets/Baby/training
      should_shuffle_rows: true
      labels:
        sequence_data:
          transform:
            _target_: src.data.loading.components.label_function.NextKTokenMasking
            next_k: 4
      batch_size_per_device: 512
      num_workers: 8
      timeout: 60
      assign_files_by_size: false
      oov_token: null
      masking_token: -1
      sequence_length: 120
      padding_token: -1
      drop_last: true
      persistent_workers: true
      collate_fn:
        _target_: src.data.loading.components.collate_functions.collate_with_sid_causal_duplicate
        _partial_: true
        sequence_length: 120
        padding_token: -1
        sequence_field_name: sequence_data
        sid_hierarchy: 4
        max_batch_size: 512
      dataset_config:
        _target_: src.data.loading.components.interfaces.SemanticIDDatasetConfig
        user_id_field: user_id
        min_sequence_length: 5
        iterate_per_row: true
        keep_user_id: true
        features_to_consider:
        - sequence_data
        - user_id
        num_placeholder_tokens_map:
          sequence_data: 0
        semantic_id_map:
          sequence_data:
            _target_: torch.load
            _args_:
            - _target_: src.utils.file_utils.open_local_or_remote
              file_path: ../datasets/Baby/codebook.pt
              mode: rb
        data_iterator:
          _target_: src.data.loading.components.iterators.InterFileIterator
          data_folder: ../datasets/Baby/training
          file_pattern: '*.train.inter'
          min_sequence_length: 5
        preprocessing_functions:
        - _target_: src.data.loading.components.pre_processing.filter_features_to_consider
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.convert_fields_to_tensors
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.map_sparse_id_to_semantic_id
          _partial_: true
          features_to_apply:
          - sequence_data
          num_hierarchies: 4
      assign_all_files_per_worker: true
    val_dataloader_config:
      _target_: src.data.loading.components.interfaces.SequenceDataloaderConfig
      dataset_class:
        _target_: src.data.loading.components.dataloading.UnboundedSequenceIterable
        _partial_: true
      data_folder: ../datasets/Baby/evaluation
      should_shuffle_rows: false
      labels:
        sequence_data:
          transform:
            _target_: src.data.loading.components.label_function.NextKTokenMasking
            next_k: 4
      batch_size_per_device: 8
      num_workers: 8
      timeout: 60
      assign_files_by_size: true
      oov_token: null
      masking_token: -1
      sequence_length: 120
      padding_token: -1
      drop_last: false
      persistent_workers: false
      collate_fn:
        _target_: src.data.loading.components.collate_functions.collate_fn_train
        _partial_: true
        sequence_length: 120
        padding_token: -1
      dataset_config:
        _target_: src.data.loading.components.interfaces.SemanticIDDatasetConfig
        user_id_field: user_id
        min_sequence_length: 5
        iterate_per_row: true
        keep_user_id: true
        features_to_consider:
        - sequence_data
        - user_id
        num_placeholder_tokens_map:
          sequence_data: 0
        semantic_id_map:
          sequence_data:
            _target_: torch.load
            _args_:
            - _target_: src.utils.file_utils.open_local_or_remote
              file_path: ../datasets/Baby/codebook.pt
              mode: rb
        data_iterator:
          _target_: src.data.loading.components.iterators.InterFileIterator
          data_folder: ../datasets/Baby/evaluation
          file_pattern: '*.valid.inter'
          min_sequence_length: 5
        preprocessing_functions:
        - _target_: src.data.loading.components.pre_processing.filter_features_to_consider
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.convert_fields_to_tensors
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.map_sparse_id_to_semantic_id
          _partial_: true
          features_to_apply:
          - sequence_data
          num_hierarchies: 4
      pin_memory: false
    test_dataloader_config:
      _target_: src.data.loading.components.interfaces.SequenceDataloaderConfig
      dataset_class:
        _target_: src.data.loading.components.dataloading.UnboundedSequenceIterable
        _partial_: true
      data_folder: ../datasets/Baby/testing
      should_shuffle_rows: false
      labels:
        sequence_data:
          transform:
            _target_: src.data.loading.components.label_function.NextKTokenMasking
            next_k: 4
      batch_size_per_device: 8
      num_workers: 8
      timeout: 60
      assign_files_by_size: true
      oov_token: null
      masking_token: -1
      sequence_length: 120
      padding_token: -1
      drop_last: false
      persistent_workers: false
      collate_fn:
        _target_: src.data.loading.components.collate_functions.collate_fn_train
        _partial_: true
        sequence_length: 120
        padding_token: -1
      dataset_config:
        _target_: src.data.loading.components.interfaces.SemanticIDDatasetConfig
        user_id_field: user_id
        min_sequence_length: 5
        iterate_per_row: true
        keep_user_id: true
        features_to_consider:
        - sequence_data
        - user_id
        num_placeholder_tokens_map:
          sequence_data: 0
        semantic_id_map:
          sequence_data:
            _target_: torch.load
            _args_:
            - _target_: src.utils.file_utils.open_local_or_remote
              file_path: ../datasets/Baby/codebook.pt
              mode: rb
        data_iterator:
          _target_: src.data.loading.components.iterators.InterFileIterator
          data_folder: ../datasets/Baby/testing
          file_pattern: '*.test.inter'
          min_sequence_length: 5
        preprocessing_functions:
        - _target_: src.data.loading.components.pre_processing.filter_features_to_consider
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.convert_fields_to_tensors
          _partial_: true
        - _target_: src.data.loading.components.pre_processing.map_sparse_id_to_semantic_id
          _partial_: true
          features_to_apply:
          - sequence_data
          num_hierarchies: 4
      pin_memory: false
trainer:
  _target_: lightning.pytorch.trainer.Trainer
  default_root_dir: /data/jwna230/peiyu/GenRec/MM-RQVAE/autoregression/outputs/2025-08-09/21-19-26
  min_steps: 1
  max_steps: 320000
  max_epochs: 10
  accelerator: gpu
  devices: -1
  num_nodes: 1
  precision: 32-true
  log_every_n_steps: 100
  val_check_interval: 1600
  deterministic: false
  accumulate_grad_batches: 16
  profiler:
    _target_: lightning.pytorch.profilers.PassThroughProfiler
  strategy: ddp
  sync_batchnorm: true
  num_sanity_val_steps: 0
  min_epochs: 0
callbacks:
  model_checkpoint:
    _target_: lightning.pytorch.callbacks.ModelCheckpoint
    dirpath: /data/jwna230/peiyu/GenRec/MM-RQVAE/autoregression/outputs/2025-08-09/21-19-26/checkpoints
    filename: checkpoint_{epoch:03d}_{step:06d}
    monitor: val/recall@5
    verbose: true
    save_last: null
    save_top_k: 1
    mode: max
    auto_insert_metric_name: true
    save_weights_only: false
    every_n_train_steps: null
    train_time_interval: null
    every_n_epochs: null
    save_on_train_epoch_end: false
  early_stopping:
    _target_: lightning.pytorch.callbacks.EarlyStopping
    monitor: val/recall@5
    min_delta: 0.0
    patience: 10
    verbose: true
    mode: max
    strict: true
    check_finite: true
    stopping_threshold: null
    divergence_threshold: null
    check_on_train_epoch_end: false
  model_summary:
    _target_: lightning.pytorch.callbacks.RichModelSummary
    max_depth: -1
  restart_job:
    _target_: src.utils.restart_job.RestartAndLoadCheckpointCallback
    metadata_dir: /data/jwna230/peiyu/GenRec/MM-RQVAE/autoregression/outputs/2025-08-09/21-19-26/metadata
extras:
  ignore_warnings: false
  enforce_tags: true
  print_config_warnings: true
  print_config: true
task_name: train
tags:
- amazon-p5-gr-train
ckpt_path: null
seed: 42
